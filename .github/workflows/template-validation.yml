name: Template System Validation

on:
  push:
    branches: [ main, develop ]
    paths:
      - '_templates/**'
      - 'tier-index.yaml'
      - 'scripts/validate_docs.py'
      - 'scripts/tier_config.py'
  pull_request:
    branches: [ main ]
    paths:
      - '_templates/**'
      - 'tier-index.yaml'
      - 'scripts/validate_docs.py'
      - 'scripts/tier_config.py'
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  validate-tier-sync:
    name: Validate Tier Index Sync
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml

      - name: Validate tier-index.yaml sync
        run: |
          python3 scripts/validate_docs.py --check-sync --index tier-index.yaml

      - name: Validate template availability
        run: |
          python3 scripts/validate_docs.py --consistency-report --index tier-index.yaml

  validate-tier-compliance:
    name: Validate Tier Compliance
    runs-on: ubuntu-latest
    strategy:
      matrix:
        tier: [mvp, core, full]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml

      - name: Validate tier compliance
        run: |
          python3 scripts/validate_docs.py --tier ${{ matrix.tier }} --index tier-index.yaml

  validate-dynamic-config:
    name: Validate Dynamic Configuration
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml

      - name: Test dynamic tier config
        run: |
          # Test all tiers
          for tier in mvp core full; do
            echo "Testing tier: $tier"
            python3 scripts/tier_config.py $tier bash > /tmp/tier_${tier}.sh
            if [ $? -ne 0 ]; then
              echo "âŒ Dynamic config failed for tier: $tier"
              exit 1
            fi
            
            # Verify output contains expected variables
            if ! grep -q "REQUIRED_FILES=" /tmp/tier_${tier}.sh; then
              echo "âŒ Missing REQUIRED_FILES in tier config output for: $tier"
              exit 1
            fi
            
            echo "âœ… Tier config valid for: $tier"
          done

      - name: Validate QUICKSTART-AI.md integration
        run: |
          # Check that QUICKSTART-AI.md references the dynamic config script
          if ! grep -q "python3 scripts/tier_config.py" QUICKSTART-AI.md; then
            echo "âŒ QUICKSTART-AI.md doesn't use dynamic tier config"
            exit 1
          fi
          
          echo "âœ… QUICKSTART-AI.md properly integrated with dynamic config"

  validate-template-versions:
    name: Validate Template Versions
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml

      - name: Validate version metadata
        run: |
          python3 scripts/validate_template_versions.py

  generate-consistency-report:
    name: Generate Consistency Report
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'push'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml

      - name: Generate comprehensive report
        run: |
          python3 scripts/validate_docs.py --consistency-report --index tier-index.yaml > consistency-report.json

      - name: Upload consistency report
        uses: actions/upload-artifact@v3
        with:
          name: consistency-report
          path: consistency-report.json
          retention-days: 30

      - name: Comment PR with report (if on PR)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const report = JSON.parse(fs.readFileSync('consistency-report.json', 'utf8'));
            
            const comment = `
            ## ğŸ“Š Template System Consistency Report
            
            **Overall Status**: ${report.overall_status ? 'âœ… PASS' : 'âŒ FAIL'}
            **Generated**: ${report.timestamp}
            
            ### Tier Index Sync
            - Valid: ${report.tier_index_sync.tier_index_valid ? 'âœ…' : 'âŒ'}
            - Missing Templates: ${report.tier_index_sync.missing_templates.length}
            
            ### Template Availability
            - All Available: ${report.template_availability.all_available ? 'âœ…' : 'âŒ'}
            - Available: ${report.template_availability.available_count}
            - Missing: ${report.template_availability.missing_count}
            
            ### Cross References
            - Broken Links: ${report.cross_references.broken_links.length}
            - Files Checked: ${report.cross_references.total_checked}
            
            ### Placeholder Consistency
            - Consistent: ${report.placeholder_consistency.consistent ? 'âœ…' : 'âŒ'}
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
