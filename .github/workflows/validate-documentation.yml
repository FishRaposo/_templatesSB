name: Validate Documentation

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  validate-documentation:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '[PYTHON_VERSION]'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r [REQUIREMENTS_FILE]
        
    - name: Validate feature documentation
      run: |
        python [VALIDATION_SCRIPT_PATH] \
          --api-dir [API_DIR] \
          --features-file [FEATURES_FILE] \
          --json \
          --threshold [GAP_THRESHOLD] > validation-report.json
      
    - name: Generate documentation report
      if: always()
      run: |
        python [VALIDATION_SCRIPT_PATH] \
          --api-dir [API_DIR] \
          --features-file [FEATURES_FILE] \
          --update
      
    - name: Upload validation report
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: documentation-validation-report
        path: |
          [FEATURES_FILE]
          validation-report.json
        retention-days: 30
        
    - name: Comment PR with validation results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          
          try {
            const report = JSON.parse(fs.readFileSync('validation-report.json', 'utf8'));
            
            const comment = `
            ## üìä Documentation Validation Results
            
            **Summary:**
            - Documented Endpoints: ${report.documented_endpoints}
            - Actual Endpoints: ${report.actual_endpoints}
            - Gap: ${report.gap_percentage.toFixed(1)}%
            - Status: ${report.is_valid ? '‚úÖ VALID' : '‚ùå INVALID'}
            
            **Details:**
            - Missing from Documentation: ${report.missing_count}
            - Extra in Documentation: ${report.extra_count}
            - Threshold Met: ${report.threshold_met ? '‚úÖ' : '‚ùå'}
            
            ${!report.is_valid || report.gap_percentage > [GAP_THRESHOLD] ? 
              '‚ö†Ô∏è **Action Required**: Please update documentation to match implementation.' : 
              '‚úÖ **Documentation is accurate!**'}
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
          } catch (error) {
            console.log('Could not read validation report:', error);
          }
