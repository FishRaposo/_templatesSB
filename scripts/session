#!/bin/bash
#
# Session Management Script
# Handles session summaries, checkpoints, and end-of-session logging
#

WORKSPACE_DIR="/root/.openclaw/workspace"
MEMORY_DIR="${WORKSPACE_DIR}/memory"
SESSION_STATE="${WORKSPACE_DIR}/.session-state.json"
DAILY_NOTE="${MEMORY_DIR}/$(date +%Y-%m-%d).md"

# Ensure daily note exists
ensure_daily_note() {
    if [ ! -f "$DAILY_NOTE" ]; then
        cat > "$DAILY_NOTE" << EOF
# $(date +%Y-%m-%d) - Session Log

**Started:** $(date +"%H:%M")

---

## Activity Log

EOF
    fi
}

# Log an activity to daily note
log_activity() {
    local activity="$1"
    ensure_daily_note
    echo "- [$(date +"%H:%M")] $activity" >> "$DAILY_NOTE"
}

# Checkpoint - update CURRENT.md with progress
checkpoint() {
    local progress="$1"
    local current_file="${MEMORY_DIR}/CURRENT.md"
    
    if [ -f "$current_file" ]; then
        # Update the "Last Updated" timestamp
        sed -i "s/Last Updated:.*/Last Updated: $(date +%Y-%m-%d)/" "$current_file"
        
        # Append progress to Current Focus if provided
        if [ -n "$progress" ]; then
            echo "" >> "$current_file"
            echo "### $(date +"%H:%M") Checkpoint" >> "$current_file"
            echo "$progress" >> "$current_file"
        fi
    fi
    
    log_activity "Checkpoint: $progress"
}

# End of session summary
session_end() {
    ensure_daily_note
    
    cat >> "$DAILY_NOTE" << EOF

---

## Session Summary

**Ended:** $(date +"%H:%M")

### Completed
- $(grep "^\- \[" "$DAILY_NOTE" | wc -l) activities logged

### Decisions
$(grep -i "\[decision\]" "$DAILY_NOTE" 2>/dev/null || echo "- None recorded")

### Next Steps
- [ ] Review today's work
- [ ] Plan tomorrow's focus

EOF

    # Update session state
    echo '{"active": false, "last_session": "'$(date +%Y-%m-%d)'", "ended_at": "'$(date +%H:%M)'"}' > "$SESSION_STATE"
    
    echo "Session ended. Summary written to $DAILY_NOTE"
}

# Start new session
session_start() {
    ensure_daily_note
    
    echo '{"active": true, "started_at": "'$(date +%H:%M)'", "date": "'$(date +%Y-%m-%d)'"}' > "$SESSION_STATE"
    
    log_activity "Session started"
    echo "Session started. Logging to $DAILY_NOTE"
}

# Show current session status
session_status() {
    if [ -f "$SESSION_STATE" ]; then
        cat "$SESSION_STATE"
    else
        echo '{"active": false}'
    fi
}

# Main
command="${1:-status}"
shift || true

case "$command" in
    start)
        session_start
        ;;
    end)
        session_end
        ;;
    checkpoint)
        checkpoint "$@"
        ;;
    log)
        log_activity "$@"
        ;;
    status)
        session_status
        ;;
    *)
        echo "Usage: session {start|end|checkpoint|log|status} [args]"
        exit 1
        ;;
esac
